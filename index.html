// Inside startPuzzle function
// Add before shuffled.forEach:
const occupiedGrid = Array(size).fill(null).map(() => Array(size).fill(null));

// Inside shuffled.forEach, replace checkPlacement() with the updated function:
function checkPlacement() {
  const correctX = parseInt(piece.dataset.correctX);
  const correctY = parseInt(piece.dataset.correctY);
  const targetX = correctX * tileSize;
  const targetY = correctY * tileSize;
  const deltaX = Math.abs(piece.offsetLeft - targetX);
  const deltaY = Math.abs(piece.offsetTop - targetY);

  if (deltaX < 15 && deltaY < 15) {
    // If another piece is already in this position, move it out
    const existing = occupiedGrid[correctY][correctX];
    if (existing && existing !== piece) {
      existing.style.left = `${Math.random() * (300 - tileSize)}px`;
      existing.style.top = `${Math.random() * (300 - tileSize)}px`;
      existing.style.zIndex = 10;
    }

    piece.style.left = `${targetX}px`;
    piece.style.top = `${targetY}px`;
    piece.style.zIndex = 1;
    if (occupiedGrid[correctY][correctX] !== piece) {
      correctCount++;
    }
    occupiedGrid[correctY][correctX] = piece;

    if (correctCount === size * size) {
      clearInterval(interval);
      const reward = timeLeft > 20 ? 200 : timeLeft > 10 ? 100 : 50;
      showPrize(reward);
    }
  } else {
    piece.classList.add("shake");
    setTimeout(() => piece.classList.remove("shake"), 300);
  }
}

// Also reset correctCount and occupiedGrid at start:
correctCount = 0;
occupiedGrid.forEach(row => row.fill(null));
